<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>í‰ê°€ìœ„ì› ì±„ì í‘œ</title>
  <style>
    body { 
      font-family: 'ë§‘ì€ ê³ ë”•', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
      margin: 0 auto; width: 95%; 
      background-color: #f8f9fa;
      line-height: 1.6;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 10px; 
      font-size: 11px;
      background: white;
    }
    th, td { 
      border: 1px solid #dee2e6; 
      padding: 6px; 
      text-align: center; 
      vertical-align: middle; 
    }
    th { 
      background: #e9ecef; 
      font-weight: 600;
      color: #495057;
    }
    textarea { 
      width: 100%; 
      height: 80px; 
      border: 1px solid #ced4da; 
      font-size: 11px; 
      padding: 8px; 
      resize: none;
      border-radius: 4px;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    textarea:focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    input[type="text"] { 
      width: 180px; 
      text-align: center; 
      height: 32px; 
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 0 8px;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    input[type="text"]:focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    select { 
      height: 32px; 
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 0 8px;
      background-color: white;
    }
    .section-title { 
      font-size: 20px; 
      font-weight: bold; 
      margin: 20px 0; 
      text-align: center;
      color: #343a40;
    }
    .score-cell label { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      font-size: 10px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.15s ease-in-out;
    }
    .score-cell label:hover {
      background-color: #f8f9fa;
    }
    .score-cell input[type="radio"] {
      margin-bottom: 4px;
    }
    #totalTextCell { 
      text-align: right; 
      font-weight: bold; 
      border: none; 
      padding: 12px 0; 
      font-size: 16px;
      color: #495057;
      background-color: #f8f9fa;
    }
    .btn-row { 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end; 
      margin: 20px 0;
    }
    .btn { 
      padding: 10px 20px; 
      font-size: 14px; 
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 4px;
      transition: all 0.15s ease-in-out;
      font-weight: 500;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .submit-btn {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .submit-btn:hover:not(:disabled) {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    .btn:not(.submit-btn) {
      background-color: #6c757d;
      color: white;
      border-color: #6c757d;
    }
    .btn:not(.submit-btn):hover:not(:disabled) {
      background-color: #545b62;
      border-color: #4e555b;
    }
    .btn[onclick="resetForm()"]:hover:not(:disabled) {
      background-color: #c82333;
      border-color: #bd2130;
    }
    .form-group {
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-group label {
      font-weight: 600;
      color: #495057;
      min-width: 80px;
    }
    @media print { 
      .btn-row { display: none; }
      body { background-color: white; }
      .container { box-shadow: none; }
    }
    @media (max-width: 768px) {
      body { width: 98%; }
      .form-group { flex-direction: column; align-items: flex-start; }
      .btn-row { flex-direction: column; }
      .btn { width: 100%; }
    }
  </style>

  <!-- html2pdf (PDF ì €ì¥ìš©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Supabase JS SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <h2 class="section-title">í‰ê°€ìœ„ì›ë³„ ì±„ì í‘œ</h2>

  <div style="text-align:center;margin:20px 0;">
    <div class="form-group" style="justify-content:center;margin:15px 0;">
      <label><strong>ì‚¬ì—…ëª…:</strong></label>
      <span>ì˜ì •ì •ë³´ì‹œìŠ¤í…œ ìš´ì˜ ìš©ì—­</span>
    </div>
    <div class="form-group" style="justify-content:center;margin:15px 0;gap:30px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <label><strong>ì œì•ˆì‚¬ëª…:</strong></label>
        <select id="proposalName" required>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="A">A</option><option value="B">B</option>
          <option value="C">C</option><option value="D">D</option>
          <option value="E">E</option><option value="F">F</option>
          <option value="G">G</option><option value="H">H</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <label><strong>í‰ê°€ìœ„ì›:</strong></label>
        <input type="text" id="evaluator" required placeholder="í‰ê°€ìœ„ì›ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
    </div>
  </div>


<form id="scoreForm">
  <table>
    <thead>
      <tr>
        <th>í‰ê°€í•­ëª©</th>
        <th>ì„¸ë¶€í•­ëª©</th>
        <th>í‰ê°€ìš”ì†Œ</th>
        <th><strong>ë°°ì </strong></th>
        <th><strong>ìˆ˜</strong></th><th><strong>ìš°</strong></th><th><strong>ë¯¸</strong></th><th><strong>ì–‘</strong></th><th><strong>ê°€</strong></th>
        <th><strong>ì ìˆ˜</strong></th>
      </tr>
    </thead>
    <tbody id="scoreTableBody"></tbody>
    <tfoot>
      <tr>
        <td colspan="10" id="totalTextCell"><strong>ì´ì :</strong> <span id="totalText"><strong>0.0</strong></span> / <strong>70.0ì  ë§Œì </strong></td>
      </tr>
    </tfoot>
  </table>

  <div style="margin: 20px 0;">
    <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">ì¢…í•©ì˜ê²¬</label>
    <textarea id="comment" maxlength="700" placeholder="í‰ê°€ì— ëŒ€í•œ ì¢…í•©ì ì¸ ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ìµœëŒ€ 700ì)"></textarea>
    <div style="text-align: right; font-size: 12px; color: #6c757d; margin-top: 4px;">
      <span id="commentCount">0</span>/700ì
    </div>
  </div>

  <div class="btn-row" style="justify-content:space-between;align-items:center;">
    <button type="button" class="btn" onclick="resetForm()" style="background-color: #dc3545; border-color: #dc3545;">ì´ˆê¸°í™”</button>
    <button type="submit" class="btn submit-btn">ì œì¶œ</button>
    <div style="display:flex;gap:8px;">
      <button type="button" class="btn" onclick="saveToPDF()">PDF ì €ì¥</button>
      <button type="button" class="btn" onclick="printForm()">ì¸ì‡„</button>
    </div>
  </div>
</form>
</div>

<script>
/* ================================
   ğŸ”§ êµ¬ì„±ê°’: í”„ë¡œì íŠ¸ì— ë§ê²Œ êµì²´
   ================================ */
const SUPABASE_URL = "https://ghbcbhwzhckvcimwktdg.supabase.co"; // â† êµì²´
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoYmNiaHd6aGNrdmNpbXdrdGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTQ3MjksImV4cCI6MjA3MzU3MDcyOX0.2NrbJNePfkzIlzKREsuJvTXgQu04vSJ_ScDdRT0MIkI";           // â† êµì²´
// (ì„ íƒ) ê¸°ì¡´ GAS í´ë°± URL. í´ë°±ì´ í•„ìš” ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ë‘ê¸°.
const GAS_FALLBACK_URL = "https://script.google.com/macros/s/AKfycbxOwWfJEn06JciJ1LckdUZQtVfMP0gSUNe2of2gSZJa1DT7uLbfrHYxuPdj7NCkoKLo4w/exec";

/* ================================
   Supabase í´ë¼ì´ì–¸íŠ¸ (ê°œì„ ëœ ì´ˆê¸°í™”)
   ================================ */
let supabase;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      autoRefreshToken: true,
      persistSession: false,
      detectSessionInUrl: false
    },
    realtime: {
      params: {
        eventsPerSecond: 10
      }
    }
  });
  console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ');
  
  // ì—°ê²° í…ŒìŠ¤íŠ¸
  testSupabaseConnection();
} catch (error) {
  console.error('âŒ Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  // í´ë°± ëª¨ë“œë¡œ ì „í™˜
  window.supabaseAvailable = false;
}

/* ================================
   Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
   ================================ */
async function testSupabaseConnection() {
  try {
    console.log('ğŸ” Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
    const { data, error } = await supabase
      .from('evaluations')
      .select('count')
      .limit(1);
    
    if (error) {
      console.error('âŒ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
      if (error.code === 'PGRST116') {
        console.error('ğŸ’¡ í•´ê²°ë°©ë²•: evaluations í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Supabaseì—ì„œ í…Œì´ë¸”ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
      }
    } else {
      console.log('âœ… Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
    }
  } catch (err) {
    console.error('âŒ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜:', err);
  }
}

/* ================================
   í‰ê°€ í•­ëª©(í–‰ ë³‘í•© í¬í•¨)
   ================================ */
const í•­ëª©ëª©ë¡ = [
  { ëŒ€:"ì „ëµ ë° ë°©ë²•ë¡ (16)", rowspan:4, ì†Œ:"ì‚¬ì—…ì´í•´ë„", ë°°ì :4, ì„¤ëª…:"ì‚¬ì—…ìˆ˜í–‰ê³„íšì´ ì‚¬ì—…ì˜ ëª©í‘œ ë° íŠ¹ì„±ì— ë¶€í•©í•˜ê²Œ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ì¶”ì§„ì „ëµ", ë°°ì :4, ì„¤ëª…:"ì‚¬ì—…ìˆ˜í–‰ ì¼ì •ê³¼ ìœ„í—˜ìš”ì†Œë¥¼ ê³ ë ¤í•œ ì¶”ì§„ì „ëµ ìˆ˜ë¦½ì˜ íƒ€ë‹¹ì„±ì„ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ì¶”ì§„ì²´ê³„", ë°°ì :4, ì„¤ëª…:"ì‚¬ì—… íŠ¹ì„±ê³¼ ì œì‹œí•œ ì¶”ì§„ì „ëµì— ë”°ë¥¸ ìˆ˜í–‰ì¡°ì§ êµ¬ì„±ê³¼ ì°¸ì—¬ ì¡°ì§ê°„ ì—­í• , ì±…ì„, í’ˆì§ˆ í™•ë³´ ë°©ì•ˆì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ì‚¬ì—…ì¶”ì§„ ë°©ë²•ë¡ ", ë°°ì :4, ì„¤ëª…:"ì‚¬ì—…ì¶”ì§„ë°©ë²•ì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ì™€ ê·¸ ì‹¤ì œ ì ìš© ì‚¬ë¡€ ë° ê²½í—˜ì— ë”°ë¥¸ ë‹¨ê³„ë³„ ì‚°ì¶œë¬¼ì„ ì œì‹œí•˜ì˜€ëŠ”ì§€ í‰ê°€" },

  { ëŒ€:"ì‚¬ì—…ìˆ˜í–‰ê³„íš(30)", rowspan:5, ì†Œ:"ì»¨ì„¤íŒ… ë¶„ì„", ë°°ì :8, ì„¤ëª…:"ISP ìˆ˜ë¦½ ë°©ë²•ë¡  ë° ì ì •í•œ ë¶„ì„ ë„êµ¬ë¥¼ í™œìš©í•˜ì—¬ í˜„í–‰ ì—…ë¬´í™˜ê²½ ë° ì—…ë¬´í”„ë¡œì„¸ìŠ¤, ì‹œìŠ¤í…œì„ ì •í™•íˆ ë¶„ì„í•˜ì˜€ëŠ”ì§€ í‰ê°€í•˜ê³ , ì œì•ˆí•œ ë°©ì•ˆ ë° ê¸°ìˆ ì˜ ëª…í™•ì„±ê³¼ íƒ€ë‹¹ì„±ì„ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ì»¨ì„¤íŒ… ì„¤ê³„", ë°°ì :8, ì„¤ëª…:"í˜„í™© ë¶„ì„ì„ í† ëŒ€ë¡œ ì¼ê´€ì„± ìˆê³  ë‹¨ê¸° ë° ì¤‘ì¥ê¸°ì ìœ¼ë¡œ ì´í–‰ ê°€ëŠ¥í•œ ì „ëµê³„íšì„ êµ¬ì²´ì ìœ¼ë¡œ ìˆ˜ë¦½í•  ìˆ˜ ìˆê³  ì „ëµê³„íš ì´í–‰ì‹œ ìœ„í—˜ìš”ì¸ ë° ëŒ€ì‘ë°©ì•ˆ, ê³ ë ¤ ì‚¬í•­ ë“±ì„ ì¶©ë¶„íˆ ì œì‹œí•˜ê³  ìˆëŠ”ê°€ë¥¼ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ì œì•½ì‚¬í•­", ë°°ì :5, ì„¤ëª…:"ì œì•ˆìš”ì²­ì„œì˜ ê¸°ìˆ , í‘œì¤€, ì—…ë¬´, ë²•ì œë„ ë° ì•ˆì „ê´€ë¦¬ ë“±ì˜ ì œì•½ì¡°ê±´ ë‚´ì—ì„œ ëª©í‘œì‚¬ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ì œì‹œí•œ ìˆ˜í–‰ ë° ê²€ì¦ë°©ì•ˆì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ìˆ˜í–‰í™˜ê²½", ë°°ì :4, ì„¤ëª…:"ì»¨ì„¤íŒ… ê³¼ì—… ìˆ˜í–‰ì— í•„ìš”í•œ ì¥ë¹„ ë° ì‘ì—…ì¥ì†Œ ë“± ì¸í”„ë¼ì˜ ì¤€ë¹„ ë° ëŒ€ì‘ë°©ì•ˆì´ ì œì•ˆìš”ì²­ì„œì˜ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•  ë§Œí¼ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ë³´ì•ˆìš”êµ¬ì‚¬í•­", ë°°ì :5, ì„¤ëª…:"ê¸°ìˆ ì  ë³´ì•ˆ êµ¬í˜„ë°©ì•ˆì´ ì œì•ˆìš”ì²­ì„œì˜ ë³´ì•ˆìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•  ë§Œí¼ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },

  { ëŒ€:"í”„ë¡œì íŠ¸ê´€ë¦¬(12)", rowspan:4, ì†Œ:"ì¼ì •ê´€ë¦¬", ë°°ì :3, ì„¤ëª…:"ì‚¬ì—…ìˆ˜í–‰ì— í•„ìš”í•œ ìˆ˜í–‰ê¸°ê°„ê³¼ ì„¸ë¶€ ì¼ì •ì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ì™€ ê° í™œë™ì— í•„ìš”í•œ ì¼ì •ê³„íšì´ ì‚¬ì—…ì¶”ì§„ë°©ë²•ë¡ ì— ì œì‹œëœ ë‹¨ê³„ë³„ ì‚°ì¶œë¬¼ê³¼ ì—°ê³„í•˜ì—¬ ì ì ˆíˆ ìˆ˜ë¦½ë˜ì—ˆëŠ”ì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"í’ˆì§ˆê´€ë¦¬", ë°°ì :3, ì„¤ëª…:"í’ˆì§ˆê´€ë¦¬ë°©ì•ˆ(í’ˆì§ˆê´€ë¦¬ì˜ ë²”ìœ„, ì ˆì°¨, ì ê²€ë°©ë²• ë“±)ì´ í•´ë‹¹ ì‚¬ì—…ì˜ ìˆ˜í–‰ì— ì í•©í•œì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ê¸°ë°€ë³´ì•ˆê´€ë¦¬", ë°°ì :3, ì„¤ëª…:"ì‚¬ì—…ì„ ì¶”ì§„í•˜ëŠ” ë™ì•ˆ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì•…ì˜í–¥ìœ¼ë¡œë¶€í„° ê¸°ë°€ì„ ë³´í˜¸í•˜ê³  ì›í™œí•œ ì‚¬ì—…ìˆ˜í–‰ì˜ ë³´ì¥ì„ ìœ„í•œ ë¬¼ë¦¬ì , ê´€ë¦¬ì  ë³´ì•ˆ ì²´ê³„ ë° ëŒ€ì±…ì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ìœ„í—˜ê´€ë¦¬", ë°°ì :3, ì„¤ëª…:"ì‚¬ì—…ê³¼ ê´€ë ¨í•œ ìœ„í—˜ì— ëŒ€í•œ ì‹ë³„ ë° ë¶„ì„, ìœ„í—˜ ê´€ë¦¬ ì ˆì°¨ ë° ëŒ€ì‘ë°©ì•ˆ ë“± ìœ„í—˜ ê´€ë¦¬ê³„íšì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },

  { ëŒ€:"í”„ë¡œì íŠ¸ì§€ì›(12)", rowspan:3, ì†Œ:"êµìœ¡í›ˆë ¨", ë°°ì :4, ì„¤ëª…:"ISP ë‹´ë‹¹ì, ì£¼ìš” ì´í•´ê´€ê³„ìë¥¼ ìœ„í•´ í•„ìš”í•œ êµìœ¡í›ˆë ¨ ë‚´ìš©, ë°©ë²•, ê¸°ê°„ ë° íšŸìˆ˜ ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•˜ì˜€ëŠ”ì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ê¸°ìˆ ì§€ì›", ë°°ì :4, ì„¤ëª…:"ê¸°ìˆ ì§€ì› ëŒ€ìƒ ë²”ìœ„, ë‚´ìš© ë° ìˆ˜ì¤€, ê¸°ìˆ  ë§¤ë‰´ì–¼ ë“± ê¸°ìˆ ì§€ì›ì´ í•„ìš”í•œ ì‚¬í•­ì— ëŒ€í•œ ê³„íš ë° ë°©ì•ˆì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },
  { ëŒ€:"", ì†Œ:"ì¸ìˆ˜ì¸ê³„", ë°°ì :4, ì„¤ëª…:"ê²€ìˆ˜ ë° ì¸ê³„ ë“±ì„ ìœ„í•œ ì¸ê³„ ì „ëµê³¼ ê²€ìˆ˜ ëŒ€ìƒÂ·ë°©ë²•, ì¶©ì¡±ì¡°ê±´ ë° ì¸ê³„ê³„íšì´ êµ¬ì²´ì ì´ê³  ì ì ˆí•œì§€ í‰ê°€" },
];

/* ================================
   í‘œ ìƒì„± (í–‰ ë³‘í•©)
   ================================ */
const tbody = document.getElementById("scoreTableBody");
let currentCategory = "";
í•­ëª©ëª©ë¡.forEach((item, idx) => {
  const tr = document.createElement("tr");
  const scoreOptions = [
    item.ë°°ì ,
    +(item.ë°°ì *0.9).toFixed(1),
    +(item.ë°°ì *0.8).toFixed(1),
    +(item.ë°°ì *0.7).toFixed(1),
    +(item.ë°°ì *0.6).toFixed(1)
  ];
  tr.innerHTML = `
    ${item.ëŒ€ && item.ëŒ€ !== currentCategory ? `<td rowspan="${item.rowspan}">${item.ëŒ€}</td>` : ""}
    <td>${item.ì†Œ}</td>
    <td style="text-align:left">${item.ì„¤ëª…}</td>
    <td><strong>${item.ë°°ì }</strong></td>
    ${scoreOptions.map(val => `
      <td class="score-cell">
        <label><input type="radio" name="score${idx}" value="${val}"><span><strong>${val}</strong></span></label>
      </td>`).join("")}
    <td><span class="score-text" name="scoreVal${idx}"></span></td>
  `;
  tbody.appendChild(tr);
  currentCategory = item.ëŒ€ || currentCategory;
});

/* ================================
   í•©ê³„ ê°±ì‹  ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
   ================================ */
document.querySelectorAll('input[type=radio]').forEach(r => {
  r.addEventListener('change', e => {
    const span = document.querySelector(`span[name="scoreVal${e.target.name.replace('score','')}"]`);
    if (span) span.innerHTML = `<strong>${e.target.value}</strong>`;
    const total = Array.from(document.querySelectorAll("span[name^='scoreVal']"))
      .reduce((sum, el) => sum + parseFloat(el.textContent || 0), 0);
    document.getElementById("totalText").innerHTML = `<strong>${total.toFixed(1)}</strong>`;
  });
});

// ì¢…í•©ì˜ê²¬ ê¸€ì ìˆ˜ ì¹´ìš´í„°
document.getElementById('comment').addEventListener('input', function() {
  const count = this.value.length;
  document.getElementById('commentCount').textContent = count;
  
  // ê¸€ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
  const countElement = document.getElementById('commentCount');
  if (count > 650) {
    countElement.style.color = '#dc3545'; // ë¹¨ê°„ìƒ‰
  } else if (count > 600) {
    countElement.style.color = '#fd7e14'; // ì£¼í™©ìƒ‰
  } else {
    countElement.style.color = '#6c757d'; // íšŒìƒ‰
  }
});

/* ================================
   ë°ì´í„° ê²€ì¦ ë° ë³´ì•ˆ ìœ í‹¸
   ================================ */
function sanitizeInput(input) {
  if (typeof input !== 'string') return '';
  return input.trim().replace(/[<>\"'&]/g, function(match) {
    const escapeMap = {
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '&': '&amp;'
    };
    return escapeMap[match];
  });
}

function validateProposalName(name) {
  const validNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
  return validNames.includes(name);
}

function validateEvaluatorName(name) {
  return name.length >= 2 && name.length <= 50 && /^[ê°€-í£a-zA-Z\s]+$/.test(name);
}

function buildScoreMap() {
  const map = {};
  í•­ëª©ëª©ë¡.forEach((item, idx) => {
    const key = `Q${String(idx+1).padStart(2,'0')} ${item.ì†Œ}`;
    const score = document.querySelector(`span[name="scoreVal${idx}"]`)?.textContent || '';
    // ì ìˆ˜ ìœ íš¨ì„± ê²€ì¦
    const scoreNum = parseFloat(score);
    if (score && (isNaN(scoreNum) || scoreNum < 0 || scoreNum > item.ë°°ì )) {
      console.warn(`ì˜ëª»ëœ ì ìˆ˜: ${key} = ${score}`);
    }
    map[key] = score;
  });
  return map;
}

function validateAllChecked() {
  const required = í•­ëª©ëª©ë¡.length;
  const selected = Array.from(document.querySelectorAll("span[name^='scoreVal']"))
                  .filter(s => s.textContent?.trim()).length;
  return selected === required;
}

function validateTotalScore() {
  const total = Array.from(document.querySelectorAll("span[name^='scoreVal']"))
                 .reduce((s, el) => s + parseFloat(el.textContent || 0), 0);
  const maxScore = í•­ëª©ëª©ë¡.reduce((sum, item) => sum + item.ë°°ì , 0);
  return total >= 0 && total <= maxScore;
}

/* ================================
   ì¤‘ë³µì œì¶œ ë°©ì§€ìš© í‚¤(ë¸Œë¼ìš°ì € ë‹¨ìœ„)
   ================================ */
function ensureSubmitKey() {
  const key = localStorage.getItem('eval_submit_key');
  if (key) return key;
  const newKey = (crypto.randomUUID && crypto.randomUUID()) || (Math.random().toString(36).slice(2) + Date.now());
  localStorage.setItem('eval_submit_key', newKey);
  return newKey;
}

/* ================================
   ì œì¶œ: Supabase insert (+ì˜µì…˜ í´ë°±) - ê°œì„ ëœ ë²„ì „
   ================================ */
document.getElementById("scoreForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  // ì…ë ¥ê°’ ê²€ì¦
  const proposalName = sanitizeInput(document.getElementById("proposalName").value);
  const evaluator = sanitizeInput(document.getElementById("evaluator").value);
  const comment = sanitizeInput(document.getElementById("comment").value);
  
  // ìƒì„¸í•œ ê²€ì¦
  if (!proposalName) {
    showError('ì œì•ˆì‚¬ëª…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    document.getElementById("proposalName").focus();
    return;
  }
  
  if (!validateProposalName(proposalName)) {
    showError('ìœ íš¨í•˜ì§€ ì•Šì€ ì œì•ˆì‚¬ëª…ì…ë‹ˆë‹¤.');
    document.getElementById("proposalName").focus();
    return;
  }
  
  if (!evaluator) {
    showError('í‰ê°€ìœ„ì›ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    document.getElementById("evaluator").focus();
    return;
  }
  
  if (!validateEvaluatorName(evaluator)) {
    showError('í‰ê°€ìœ„ì›ëª…ì€ 2-50ìì˜ í•œê¸€, ì˜ë¬¸, ê³µë°±ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    document.getElementById("evaluator").focus();
    return;
  }
  
  if (!validateAllChecked()) {
    showError('ëª¨ë“  ë¬¸í•­ì— ì ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!validateTotalScore()) {
    showError('ì´ì ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì ìˆ˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }

  const total = Array.from(document.querySelectorAll("span[name^='scoreVal']"))
                 .reduce((s, el) => s + parseFloat(el.textContent || 0), 0);

  const payload = {
    proposalName, 
    evaluator,
    total: +total.toFixed(1),
    comment,
    scoreMap: buildScoreMap(),
    timestamp: new Date().toISOString()
  };

  const btn = document.querySelector('.submit-btn'); 
  btn.disabled = true; 
  btn.textContent = 'ì „ì†¡ ì¤‘â€¦';
  btn.style.opacity = '0.6';

  const record = {
    proposal_name: payload.proposalName,
    evaluator: payload.evaluator,
    total: payload.total,
    comment: payload.comment,
    score_map: payload.scoreMap,
    user_agent: navigator.userAgent || null,
    submit_key: ensureSubmitKey(),
    created_at: payload.timestamp
  };

  let done = false;
  let errorMessage = '';

  // 1) Supabase ì €ì¥ ì‹œë„
  if (supabase && window.supabaseAvailable !== false) {
    try {
      console.log('ğŸ”„ Supabaseì— ë°ì´í„° ì €ì¥ ì‹œë„...');
      console.log('ğŸ“¤ ì „ì†¡í•  ë°ì´í„°:', record);
      
      const { data, error } = await supabase
        .from('evaluations')
        .insert(record)
        .select();
        
      if (error) {
        console.error('âŒ Supabase ì˜¤ë¥˜ ìƒì„¸:', error);
        throw new Error(`Supabase ì˜¤ë¥˜: ${error.message} (ì½”ë“œ: ${error.code})`);
      }
      
      console.log('âœ… Supabase ì €ì¥ ì„±ê³µ:', data);
      done = true;
    } catch (err) {
      console.error('âŒ Supabase insert ì‹¤íŒ¨:', err);
      console.error('âŒ ì˜¤ë¥˜ ìŠ¤íƒ:', err.stack);
      errorMessage = err.message;
    }
  } else {
    console.warn('âš ï¸ Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }

  // 2) (ì„ íƒ) GAS í´ë°±
  if (!done && GAS_FALLBACK_URL) {
    try {
      console.log('ğŸ”„ GAS í´ë°±ìœ¼ë¡œ ë°ì´í„° ì €ì¥ ì‹œë„...');
      const qs = new URLSearchParams({ 
        payload: JSON.stringify(payload),
        timestamp: payload.timestamp
      }).toString();
      
      const response = await fetch(`${GAS_FALLBACK_URL}?${qs}`, { 
        method: 'GET', 
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      });
      
      console.log('âœ… GAS í´ë°± ì €ì¥ ì„±ê³µ');
      done = true;
    } catch (err) {
      console.error('âŒ GAS fallback ì‹¤íŒ¨:', err);
      errorMessage = err.message;
    }
  }

  // 3) ê²°ê³¼ ì²˜ë¦¬
  if (done) {
    showSuccess('ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    // resetForm(); // ì œì¶œ í›„ í¼ì„ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ (PDF/ì¸ì‡„ë¥¼ ìœ„í•´ ë°ì´í„° ìœ ì§€)
  } else {
    showError(`ì œì¶œ ì‹¤íŒ¨: ${errorMessage || 'ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
  }

  btn.disabled = false; 
  btn.textContent = 'ì œì¶œ';
  btn.style.opacity = '1';
});

/* ================================
   ì‚¬ìš©ì í”¼ë“œë°± í•¨ìˆ˜ë“¤
   ================================ */
function showSuccess(message) {
  // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
  const existingAlert = document.querySelector('.alert-success');
  if (existingAlert) existingAlert.remove();
  
  const alert = document.createElement('div');
  alert.className = 'alert-success';
  alert.style.cssText = `
    position: fixed; top: 20px; right: 20px; z-index: 1000;
    background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
    padding: 12px 20px; border-radius: 4px; font-size: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  `;
  alert.textContent = message;
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentNode) alert.remove();
  }, 5000);
}

function showError(message) {
  // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
  const existingAlert = document.querySelector('.alert-error');
  if (existingAlert) existingAlert.remove();
  
  const alert = document.createElement('div');
  alert.className = 'alert-error';
  alert.style.cssText = `
    position: fixed; top: 20px; right: 20px; z-index: 1000;
    background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
    padding: 12px 20px; border-radius: 4px; font-size: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  `;
  alert.textContent = message;
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentNode) alert.remove();
  }, 5000);
}

function resetForm() {
  // ì‚¬ìš©ì í™•ì¸
  if (!confirm('ëª¨ë“  ì…ë ¥ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì œì•ˆì‚¬ëª…, í‰ê°€ìœ„ì›ëª…, ì ìˆ˜, ì¢…í•©ì˜ê²¬ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
    return;
  }
  
  // í¼ ì´ˆê¸°í™”
  document.getElementById("scoreForm").reset();
  document.getElementById("totalText").innerHTML = '<strong>0.0</strong>';
  document.querySelectorAll('span[name^="scoreVal"]').forEach(s => s.textContent = '');
  document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
  document.getElementById('commentCount').textContent = '0';
  
  // ì„±ê³µ ë©”ì‹œì§€
  showSuccess('í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* ================================
   PDF ì €ì¥ (ê°œì„ ëœ ë²„ì „)
   ================================ */
function saveToPDF() {
  const proposalName = document.getElementById("proposalName").value.trim();
  const evaluator = document.getElementById("evaluator").value.trim();
  
  if (!proposalName || !evaluator) {
    showError('ì œì•ˆì‚¬ëª…ê³¼ í‰ê°€ìœ„ì›ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  // PDF ìƒì„± ì¤‘ í‘œì‹œ
  const originalBtn = event.target;
  const originalText = originalBtn.textContent;
  originalBtn.disabled = true;
  originalBtn.textContent = 'PDF ìƒì„± ì¤‘...';
  originalBtn.style.opacity = '0.6';

  // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  const btnBars = document.querySelectorAll('.btn-row'); 
  btnBars.forEach(b => b.style.display = 'none');

  // í…ìŠ¤íŠ¸ ì˜ì—­ì„ divë¡œ ë³€í™˜
  const ta = document.getElementById('comment');
  const parent = ta.parentElement;
  const tempDiv = document.createElement('div');
  tempDiv.style.cssText = 'border:1px solid #000;padding:5px;min-height:80px;white-space:pre-wrap;text-align:left;font-size:11px;';
  tempDiv.textContent = ta.value;
  ta.style.display = 'none';
  parent.insertBefore(tempDiv, ta);

  // PDF ì˜µì…˜ ì„¤ì •
  const opt = {
    margin: [10, 10, 10, 10],
    filename: `í‰ê°€í‘œ_${proposalName}_${evaluator}_${new Date().toISOString().slice(0,10)}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { 
      scale: 2, 
      useCORS: true, 
      logging: false,
      allowTaint: true,
      backgroundColor: '#ffffff'
    },
    jsPDF: { 
      unit: 'mm', 
      format: 'a4', 
      orientation: 'portrait',
      compress: true
    }
  };

  // PDF ìƒì„± ë° ì €ì¥
  html2pdf()
    .set(opt)
    .from(document.body)
    .save()
    .then(() => {
      console.log('âœ… PDF ì €ì¥ ì„±ê³µ');
      showSuccess('PDFê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    })
    .catch(err => {
      console.error('âŒ PDF ì €ì¥ ì‹¤íŒ¨:', err);
      showError('PDF ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    })
    .finally(() => {
      // UI ë³µì›
      tempDiv.remove(); 
      ta.style.display = ''; 
      btnBars.forEach(b => b.style.display = '');
      originalBtn.disabled = false;
      originalBtn.textContent = originalText;
      originalBtn.style.opacity = '1';
    });
}

/* ================================
   ì¸ì‡„ (ê°œì„ ëœ ë²„ì „)
   ================================ */
function printForm() {
  const proposalName = document.getElementById("proposalName").value.trim();
  const evaluator = document.getElementById("evaluator").value.trim();
  
  if (!proposalName || !evaluator) {
    showError('ì œì•ˆì‚¬ëª…ê³¼ í‰ê°€ìœ„ì›ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  // ì¸ì‡„ ì „ UI ì¤€ë¹„
  const btnBars = document.querySelectorAll('.btn-row'); 
  btnBars.forEach(b => b.style.display = 'none');

  // í…ìŠ¤íŠ¸ ì˜ì—­ì„ divë¡œ ë³€í™˜
  const ta = document.getElementById('comment');
  const parent = ta.parentElement;
  const tempDiv = document.createElement('div');
  tempDiv.style.cssText = 'border:1px solid #000;padding:5px;min-height:80px;white-space:pre-wrap;text-align:left;font-size:11px;';
  tempDiv.textContent = ta.value;
  ta.style.display = 'none';
  parent.insertBefore(tempDiv, ta);

  // ì¸ì‡„ ëŒ€í™”ìƒì í‘œì‹œ
  window.print();

  // ì¸ì‡„ í›„ UI ë³µì›
  setTimeout(() => {
    tempDiv.remove(); 
    ta.style.display = ''; 
    btnBars.forEach(b => b.style.display = '');
  }, 100);
}
</script>

</body>
</html>
